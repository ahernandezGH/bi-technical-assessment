name: Validate Solution

permissions:
  contents: read
  pull-requests: write

on:
  pull_request_target:
    types: [opened, synchronize, reopened]
    branches:
      - main

jobs:
  parse-pr-title:
    name: Parse PR Title
    runs-on: ubuntu-latest
    if: startsWith(github.event.pull_request.title, 'Solution - ')
    outputs:
      candidate: ${{ steps.parse.outputs.candidate }}
      issue: ${{ steps.parse.outputs.issue }}
    steps:
      - name: Parse PR Title
        id: parse
        run: |
          TITLE="${{ github.event.pull_request.title }}"
          echo "PR Title: $TITLE"
          RE="^Solution - \[?([^] -]+)\]? - Issue \[?([0-9]{3})\]?"
          if [[ "$TITLE" =~ $RE ]]; then
            CANDIDATE="${BASH_REMATCH[1]}"
            ISSUE="${BASH_REMATCH[2]}"
            echo "candidate=$CANDIDATE" >> $GITHUB_OUTPUT
            echo "issue=$ISSUE" >> $GITHUB_OUTPUT
            echo "Candidate: $CANDIDATE"
            echo "Issue: $ISSUE"
          else
            echo "ERROR: Format mismatch"
            exit 1
          fi

  validate:
    name: Run Validation Logic
    needs: parse-pr-title
    runs-on: windows-latest
    steps:
      - name: Checkout Base Repository
        uses: actions/checkout@v4
        with:
          ref: main

      - name: Checkout Candidate Solution
        uses: actions/checkout@v4
        with:
          repository: ${{ github.event.pull_request.head.repo.full_name }}
          ref: ${{ github.event.pull_request.head.sha }}
          path: candidate-solution
          sparse-checkout: |
            Solutions

      - name: Copy Candidate Solution
        run: |
          $candidate = "${{ needs.parse-pr-title.outputs.candidate }}"
          $issue = "${{ needs.parse-pr-title.outputs.issue }}"
          $srcPath = "candidate-solution\Solutions\$candidate"
          $dstPath = "Solutions\$candidate"
          if (Test-Path $srcPath) {
            Copy-Item -Path $srcPath -Destination $dstPath -Recurse -Force
            Write-Host "Copied solution from $srcPath to $dstPath"
            Write-Host "Listing destination path $dstPath:"
            if (Test-Path $dstPath) {
              Get-ChildItem $dstPath -Recurse | ForEach-Object { Write-Host $_.FullName }
            } else {
              Write-Host "ERROR: Destination path missing: $dstPath"
              exit 1
            }
          } else {
            Write-Host "ERROR: Solution path not found: $srcPath"
            exit 1
          }
        shell: pwsh

      - name: Setup SQL Server
        run: |
          sqllocaldb create MSSQLLocalDB
          sqllocaldb start MSSQLLocalDB
        shell: pwsh

      - name: Create Test Databases
        run: |
          sqlcmd -S "(localdb)\MSSQLLocalDB" -E -Q "IF NOT EXISTS (SELECT * FROM sys.databases WHERE name = 'SchoolERP_Source') CREATE DATABASE [SchoolERP_Source];"
          sqlcmd -S "(localdb)\MSSQLLocalDB" -E -Q "IF NOT EXISTS (SELECT * FROM sys.databases WHERE name = 'BI_Assessment_Staging') CREATE DATABASE [BI_Assessment_Staging];"
          sqlcmd -S "(localdb)\MSSQLLocalDB" -E -Q "IF NOT EXISTS (SELECT * FROM sys.databases WHERE name = 'BI_Assessment_DWH') CREATE DATABASE [BI_Assessment_DWH];"
        shell: pwsh

      - name: Load Test Schemas and Data
        run: |
          Get-ChildItem "Database\01_Schema" -Filter "*.sql" | Sort-Object Name | ForEach-Object { sqlcmd -S "(localdb)\MSSQLLocalDB" -E -i $_.FullName }
          Get-ChildItem "Database\02_Data" -Filter "*.sql" | Sort-Object Name | ForEach-Object { sqlcmd -S "(localdb)\MSSQLLocalDB" -E -i $_.FullName }
        shell: pwsh

      - name: Run Validator Script
        id: run_validator
        run: |
          $candidate = "${{ needs.parse-pr-title.outputs.candidate }}"
          $issue = "${{ needs.parse-pr-title.outputs.issue }}"
          Write-Host "=== Running validation for $candidate Issue $issue ==="
          try {
            & ".\Tools\Validate-Solution.ps1" -Issue $issue -Candidate "$candidate" -ServerName "(localdb)\MSSQLLocalDB" -TrustedConnection 2>&1 | Out-File -FilePath "results.txt" -Encoding UTF8
          } catch {
            "ERROR: $_" | Out-File -FilePath "results.txt" -Encoding UTF8
          }
          $content = Get-Content "results.txt" -Raw
          Write-Host "=== Validator Output ==="
          Write-Host $content
          Write-Host "=== Parsing Results ==="
          if ($content -match '(?i)SCORE:\s*([0-9]+)\s*/\s*([0-9]+)') {
            $score = $Matches[1]
            $maxScore = $Matches[2]
            Write-Host "Parsed score: $score / $maxScore"
            echo "score=$score" >> $env:GITHUB_OUTPUT
            echo "max_score=$maxScore" >> $env:GITHUB_OUTPUT
          } else {
            Write-Host "WARNING: Could not parse SCORE from output"
            echo "score=0" >> $env:GITHUB_OUTPUT
            echo "max_score=100" >> $env:GITHUB_OUTPUT
          }
          if ($content -match '(?i)STATUS:\s*(PASS|FAIL)') {
            $status = $Matches[1].ToUpper()
            Write-Host "Parsed status: $status"
            echo "status=$status" >> $env:GITHUB_OUTPUT
          } else {
            Write-Host "WARNING: Could not parse STATUS from output"
            echo "status=FAIL" >> $env:GITHUB_OUTPUT
          }
        shell: pwsh

      - name: Comment on PR
        uses: actions/github-script@v7
        with:
          github-token: ${{ secrets.GITHUB_TOKEN }}
          script: |
            const fs = require('fs');
            const candidate = '${{ needs.parse-pr-title.outputs.candidate }}';
            const issue = '${{ needs.parse-pr-title.outputs.issue }}';
            const score = '${{ steps.run_validator.outputs.score }}' || '0';
            const maxScore = '${{ steps.run_validator.outputs.max_score }}' || '100';
            const status = '${{ steps.run_validator.outputs.status }}' || 'FAIL';
            let output = 'No output available';
            try {
              output = fs.readFileSync('results.txt', 'utf8');
            } catch (e) {
              output = 'Error reading results: ' + e.message;
            }
            const prNumber = context.payload.pull_request.number;
            const emoji = status === 'PASS' ? ':white_check_mark:' : ':x:';
            const resultEmoji = status === 'PASS' ? ':tada:' : ':warning:';
            const body = `## ${emoji} Solution Validation Results

            **Candidate:** ${candidate} | **Issue:** ${issue} | **Score:** **${score}/${maxScore}** | **Status:** ${status}

            ---
            <details><summary>Full Output</summary>

            \`\`\`
            ${output}
            \`\`\`

            </details>

            ---
            ${status === 'PASS' ? `${resultEmoji} **Pass!** Eligible for Phase 2.` : `${resultEmoji} **Fail.** Please review and resubmit.`}`;

            await github.rest.issues.createComment({
              issue_number: prNumber,
              owner: context.repo.owner,
              repo: context.repo.repo,
              body: body
            });

      - name: Final Status
        if: steps.run_validator.outputs.status == 'FAIL'
        run: exit 1
        shell: pwsh
