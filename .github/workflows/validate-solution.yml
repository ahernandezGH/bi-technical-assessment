name: Validate Solution

permissions:
  contents: read
  pull-requests: write

on:
  pull_request_target:
    types: [opened, synchronize, reopened]
    branches:
      - main

jobs:
  parse-pr-title:
    name: Parse PR Title
    runs-on: ubuntu-latest
    if: startsWith(github.event.pull_request.title, 'Solution - ')
    outputs:
      candidate: ${{ steps.parse.outputs.candidate }}
      issue: ${{ steps.parse.outputs.issue }}
    steps:
      - name: Parse PR Title
        id: parse
        run: |
          TITLE="${{ github.event.pull_request.title }}"
          echo "PR Title: $TITLE"
          RE="^Solution - \[?([^] -]+)\]? - Issue \[?([0-9]{3})\]?"
          if [[ "$TITLE" =~ $RE ]]; then
            CANDIDATE="${BASH_REMATCH[1]}"
            ISSUE="${BASH_REMATCH[2]}"
            echo "candidate=$CANDIDATE" >> $GITHUB_OUTPUT
            echo "issue=$ISSUE" >> $GITHUB_OUTPUT
            echo "Candidate: $CANDIDATE"
            echo "Issue: $ISSUE"
          else
            echo "ERROR: Format mismatch"
            exit 1
          fi

  validate:
    name: Run Validation Logic
    needs: parse-pr-title
    runs-on: windows-latest
    steps:
      - name: Checkout Repository
        uses: actions/checkout@v4
        with:
          ref: ${{ github.event.pull_request.head.sha }}

      - name: Verify Solution Files
        id: verify
        run: |
          $candidate = "${{ needs.parse-pr-title.outputs.candidate }}"
          $issue = "${{ needs.parse-pr-title.outputs.issue }}"
          $solutionPath = "Solutions\$candidate\Issue$issue"
          if (-not (Test-Path $solutionPath)) { exit 1 }
        shell: pwsh

      - name: Setup SQL Server
        run: |
          sqllocaldb create MSSQLLocalDB
          sqllocaldb start MSSQLLocalDB
        shell: pwsh

      - name: Create Test Databases
        run: |
          sqlcmd -S "(localdb)\MSSQLLocalDB" -E -Q "IF NOT EXISTS (SELECT * FROM sys.databases WHERE name = 'SchoolERP_Source') CREATE DATABASE [SchoolERP_Source];"
          sqlcmd -S "(localdb)\MSSQLLocalDB" -E -Q "IF NOT EXISTS (SELECT * FROM sys.databases WHERE name = 'BI_Assessment_Staging') CREATE DATABASE [BI_Assessment_Staging];"
          sqlcmd -S "(localdb)\MSSQLLocalDB" -E -Q "IF NOT EXISTS (SELECT * FROM sys.databases WHERE name = 'BI_Assessment_DWH') CREATE DATABASE [BI_Assessment_DWH];"
        shell: pwsh

      - name: Load Test Schemas and Data
        run: |
          Get-ChildItem "Database\01_Schema" -Filter "*.sql" | Sort-Object Name | ForEach-Object { sqlcmd -S "(localdb)\MSSQLLocalDB" -E -i $_.FullName }
          Get-ChildItem "Database\02_Data" -Filter "*.sql" | Sort-Object Name | ForEach-Object { sqlcmd -S "(localdb)\MSSQLLocalDB" -E -i $_.FullName }
        shell: pwsh

      - name: Run Validator Script
        id: run_validator
        run: |
          $candidate = "${{ needs.parse-pr-title.outputs.candidate }}"
          $issue = "${{ needs.parse-pr-title.outputs.issue }}"
          & ".\Tools\Validate-Solution.ps1" -Issue $issue -Candidate "$candidate" -ServerName "(localdb)\MSSQLLocalDB" -TrustedConnection | Out-File -FilePath "results.txt" -Encoding UTF8
          $content = Get-Content "results.txt" -Raw
          Write-Host $content
          if ($content -match 'SCORE:\s*(?<score>\d+)/(?<max>\d+)') {
            echo "score=$($Matches['score'])" >> $env:GITHUB_OUTPUT
            echo "max_score=$($Matches['max'])" >> $env:GITHUB_OUTPUT
          }
          if ($content -match 'STATUS:\s*(?<status>PASS|FAIL)') {
            echo "status=$($Matches['status'])" >> $env:GITHUB_OUTPUT
          }
        shell: pwsh

      - name: Comment on PR
        uses: actions/github-script@v7
        with:
          github-token: ${{ secrets.GITHUB_TOKEN }}
          script: |
            const fs = require('fs');
            const candidate = '${{ needs.parse-pr-title.outputs.candidate }}';
            const issue = '${{ needs.parse-pr-title.outputs.issue }}';
            const score = '${{ steps.run_validator.outputs.score }}';
            const maxScore = '${{ steps.run_validator.outputs.max_score }}';
            const status = '${{ steps.run_validator.outputs.status }}';
            const output = fs.readFileSync('results.txt', 'utf8');
            const prNumber = context.payload.pull_request.number;
            const body = `## ${status === 'PASS' ? '' : ''} Solution Validation Results
            **Candidate:** ${candidate} | **Issue:** ${issue} | **Score:** **${score}/${maxScore}** | **Status:** ${status}
            ---
            <details><summary>Full Output</summary>\n\n\`\`\`\n${output}\n\`\`\`\n</details>
            ---
            ${status === 'PASS' ? ' **Pass!** Eligible for Phase 2.' : ' **Fail.** Please review and resubmit.'}`;
            await github.rest.issues.createComment({ 
              issue_number: prNumber, 
              owner: context.repo.owner, 
              repo: context.repo.repo, 
              body: body 
            });

      - name: Final Status
        if: steps.run_validator.outputs.status == 'FAIL'
        run: exit 1
        shell: pwsh
